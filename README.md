# Kaspi API Integration Service

## Описание

Асинхронный сервис для интеграции с Kaspi API, обработки заказов, управления остатками и синхронизации с внутренней БД (PostgreSQL). Поддерживает устойчивую работу за счёт retry/backoff, пакетной обработки и логирования.

## Основные возможности
- Получение и обработка новых заказов с Kaspi API
- Пакетная обработка заказов с ограничением числа одновременных задач
- Обработка отменённых заказов и возвратов
- Асинхронная работа с БД через SQLAlchemy
- Устойчивость к временным ошибкам (retry с backoff для сети и БД)
- Логирование бизнес-событий

## Структура проекта

- `main.py` — точка входа, запуск бизнес-процессов
- `kaspi.py` — работа с Kaspi API (aiohttp, retry)
- `stock_service.py` — бизнес-логика обработки заказов (batch, async)
- `stock_repository.py` — работа с БД (async SQLAlchemy, retry)
- `models/` — ORM-модели
- `settings/` — конфигурация, подключение к БД, логгер
- `test_*.py` — базовые smoke-тесты

## Запуск

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Настройте переменные окружения (см. `.env.example`):
   - KASPI_API_URL, KASPI_AUTH_TOKEN, KASPI_CONTENT_TYPE, KASPI_USER_AGENT
   - DATABASE_URL (PostgreSQL)
3. Запустите основной сервис:
   ```bash
   python main.py
   ```
4. Для тестов:
   ```bash
   pytest
   ```

## Ключевые параметры
- Количество одновременных задач: `CONCURRENT_ORDER_LIMIT` (по умолчанию 5)
- Все сетевые и БД-операции защищены retry/backoff

## Примечания
- Для production рекомендуется отдельная БД для тестов и настройка переменных окружения.
- Для интеграционных тестов используйте тестовые данные и/или мок-сервисы.

---

Автор: [ваше имя]
